<p-dialog [(visible)]="visible" [modal]="true" styleClass="custom-header-naranja" [closable]="true"
    [style]="{ width: '50rem', height: 'auto' }" (onHide)="cerrar()" (onShow)="onDialogShow()" class="bodyDialog">
    <ng-template pTemplate="header">
        <label>
            <h2>Administraci√≥n de proceso</h2>
        </label>
    </ng-template>
    <br>
    <ng-template pTemplate="content">
        <div class="row col-12">
            <div class="col-3" style="text-align: left; padding-right: 0px; width: auto;">
                <label for="nombreProceso" style="padding-top: 6px;">Nombre del Proceso
                </label>
            </div>
            <div class="col-9" style="text-align: left; padding-bottom: 10px;">
                <input id="nombreProceso" [(ngModel)]="etapasActivas[0].nombreProceso" placeholder="Nombre del proceso" pInputText
                    class="p-inputtext" style="width: 111%;" />
            </div>
        </div>

        <h3 style="justify-self: left;">Etapas</h3>
        <div cdkDropList [cdkDropListData]="etapas" (cdkDropListDropped)="dropEtapa($event)" class="lista-etapas">
            <div *ngFor="let etapa of etapasActivas; let i = index" cdkDrag class="col-12 etapa-item">
                <div class="col-1">
                    <span cdkDragHandle class="handle">‚ãÆ‚ãÆ‚ãÆ</span>
                </div>
                <div class="col-9" *ngIf="!etapa.editandoNombre" style="text-align: left;">
                    <span class="etapa-nombre">{{ etapa.nombre }}</span>
                    <span class="etapa-probabilidad">{{ etapa.probabilidad }}%</span>

                </div>
                <div class="col-2" *ngIf="!etapa.editandoNombre">
                    <button (click)="editarNombreEtapa(etapa)" class="boton-editar">‚úèÔ∏è</button>
                    <button (click)="eliminarEtapa(etapa)" class="boton-eliminar">‚ùå</button>
                </div>
                <div *ngIf="etapa.editandoNombre" class="col-9 formulario-edicion">
                    <p-select [options]="etapasActivas" 
                    [(ngModel)]="etapa.etapaSeleccionada" 
                    optionLabel="nombre"
                        [filter]="true" 
                        filterBy="nombre" 
                        [showClear]="true"
                        placeholder="{{etapa.textoBusqueda || 'Selecciona una etapa'}}" 
                        class="w-full md:w-56"
                        (onChange)="seleccionarEtapaExistente(etapa, $event.value)" 
                        (onFilter)="filtrarEtapa($event, etapa)"
                        [ngStyle]="{ width: '-webkit-fill-available', height: '41px', 'text-align': 'left', 'padding-top': '4px', 'padding-left': '6px' }"
                        appendTo="body">
                        <ng-template #selectedItem let-selectedOption>
                            <div class="flex items-center gap-2">
                                <i class="pi pi-user"></i>
                                <div>{{ selectedOption?.nombre || 'Seleccione una etapa' }}</div>
                            </div>
                        </ng-template>

                        <ng-template let-item #item>
                            <div class="flex items-center gap-2">
                                <i class="pi pi-user"></i>
                                <div>{{ item.nombre }}</div>
                            </div>
                        </ng-template>

                        <ng-template #footer>
                            <div class="p-3 text-center">
                                <button class="btnAgregarProspectoContacto" [disabled]="!etapa.textoBusqueda" (click)="agregarEtapaDesdeBusqueda(etapa)" size="small"> +
                                    Agregar Etapa</button>
                            </div>
                        </ng-template>
                    </p-select>
                    <input [(ngModel)]="etapa.probabilidad" type="number" max="100" placeholder="Probabilidad"
                        pInputText class="p-inputtext" style="height: 41px;" />
                </div>
                <div class="col-2" *ngIf="etapa.editandoNombre">
                    <button (click)="guardarNombreEtapa(etapa)" class="boton-guardar">üíæ</button>
                </div>

            </div>
        </div>
        <div class="boton-agregar-contenedor">
            <button mat-button (click)="agregarEtapa()" class="boton-agregar">
                +
            </button>
            <span class="texto-agregar">Agregar etapa</span>
        </div>
    </ng-template>
    <ng-template pTemplate="footer">
        <button mat-button color="primary" class="btn-agregar-etapa" (click)="toggleEditarOrdenEtapas()"
            [disabled]="!validaGuardar">Guardar</button>
        <button mat-button class="btn-agregar-etapa" (click)="cerrar()">Cancelar</button>

    </ng-template>

    <p-confirmDialog header="Confirmaci√≥n" [message]="'¬øEst√°s seguro de que deseas eliminar esta etapa?'"
        [acceptLabel]="'S√≠'" [rejectLabel]="'No'" acceptButtonStyleClass="p-button-secondary">
    </p-confirmDialog>

    <div style="position: absolute; z-index:1102; text-align: center;">
        <p-toast key="toast" position="bottom-center" [style]="{ height: '2vh' }"></p-toast>
    </div>
</p-dialog>